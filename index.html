<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cruise Official</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --primary: #2481cc; --bg: #000; --panel: #111; --border: #262626; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); color: #fff; font-family: -apple-system, system-ui, sans-serif; overflow: hidden; }

        /* HEADER & LOGO */
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 20px; height: 60px; background: #000; border-bottom: 1px solid var(--border);
        }
        .logo-text { font-weight: 900; letter-spacing: 5px; font-size: 18px; color: var(--primary); }
        .live-tag { font-size: 9px; background: #00ff0022; color: #00ff00; padding: 2px 8px; border-radius: 10px; border: 1px solid #00ff0044; }

        /* VIEWS */
        .view { display: none; height: calc(100vh - 130px); width: 100%; overflow: hidden; position: relative; }
        .view.active { display: block; }

        /* FEED CARDS */
        #post-container { width: 100%; height: 100%; position: relative; }
        .post-card { 
            position: absolute; inset: 0; padding: 20px; display: flex; flex-direction: column; 
            background: #000; transition: transform 0.5s cubic-bezier(0.2, 1, 0.3, 1);
        }
        .card-body { 
            background: var(--panel); border: 1px solid var(--border); border-radius: 25px; 
            padding: 20px; height: 80%; display: flex; flex-direction: column;
        }
        .user-row { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .avatar { width: 35px; height: 35px; border-radius: 10px; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .content-text { font-size: 18px; line-height: 1.5; overflow-y: auto; }

        /* BOTTOM NAV MENU */
        .bottom-nav { 
            position: fixed; bottom: 0; width: 100%; height: 70px; 
            background: #050505; border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center; z-index: 1000;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #666; font-size: 10px; border: none; background: none; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 20px; }

        /* EDITOR */
        #editor { 
            position: fixed; inset: 0; background: #000; z-index: 5000; 
            transform: translateY(100%); transition: 0.4s cubic-bezier(0.1, 0.8, 0.1, 1); 
            padding: 25px; display: flex; flex-direction: column; 
        }
        #editor.active { transform: translateY(0); }
        .ed-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        #post-input { flex: 1; background: transparent; border: none; color: #fff; font-size: 20px; resize: none; }
        
        /* FILE UPLOAD AREA */
        .upload-bar { border-top: 1px solid var(--border); padding: 15px 0; display: flex; gap: 15px; }
        .upload-btn { background: #1a1a1a; padding: 10px 15px; border-radius: 12px; font-size: 14px; color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo-text">CRUISE</div>
        <div id="status" class="live-tag">SYNCING...</div>
    </div>

    <main id="view-home" class="view active">
        <div id="post-container"></div>
    </main>

    <main id="view-shorts" class="view">
        <div style="display:flex; height:100%; align-items:center; justify-content:center; color:#444;">Shorts Player Coming Soon</div>
    </main>

    <main id="view-profile" class="view">
        <div style="padding:40px; text-align:center;">
            <div id="my-avatar" style="width:80px; height:80px; background:var(--primary); border-radius:25px; margin:0 auto 20px; display:flex; align-items:center; justify-content:center; font-size:30px; font-weight:bold;">?</div>
            <h2 id="my-name">User</h2>
            <p style="color:#666;">Global Cruiser</p>
        </div>
    </main>

    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('home', this)">
            <span class="nav-icon">üöÄ</span><span>Feed</span>
        </button>
        <button class="nav-item" onclick="switchTab('shorts', this)">
            <span class="nav-icon">üé¨</span><span>Shorts</span>
        </button>
        <button class="nav-item" onclick="openEditor()">
            <span class="nav-icon" style="color:var(--primary); font-size:30px;">+</span>
        </button>
        <button class="nav-item" onclick="switchTab('profile', this)">
            <span class="nav-icon">üë§</span><span>Profile</span>
        </button>
    </div>

    <div id="editor">
        <div class="ed-header">
            <button onclick="closeEditor()" style="background:none; border:none; color:#666;">Cancel</button>
            <button onclick="publish()" style="background:var(--primary); color:#fff; border:none; padding:8px 20px; border-radius:12px; font-weight:bold;">Cruise It</button>
        </div>
        <textarea id="post-input" placeholder="What's the vibe today?"></textarea>
        
        <div class="upload-bar">
            <label for="file-up" class="upload-btn">üìÅ Upload from Phone</label>
            <input type="file" id="file-up" style="display:none;" onchange="tg.showAlert('File selected! Handling upload...')">
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const SB_URL = "https://chsybopznpfdvhmdspox.supabase.co"; 
        const SB_KEY = "sb_publishable_IfqycsZxpWeXgSPA5U7D5w_u-nl_FJf";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        let posts = [];
        let cur = 0;

        // LOAD USER DATA
        if(tg.initDataUnsafe?.user) {
            document.getElementById('my-name').innerText = tg.initDataUnsafe.user.first_name;
            document.getElementById('my-avatar').innerText = tg.initDataUnsafe.user.first_name[0];
        }

        async function fetchPosts() {
            const { data, error } = await supabaseClient.from('posts').select('*').order('created_at', { ascending: false });
            if (!error) {
                posts = data;
                document.getElementById('status').innerText = "GLOBAL LIVE";
                render();
            }
        }

        function render() {
            const container = document.getElementById('post-container');
            if (posts.length === 0) {
                container.innerHTML = `<div style="padding:100px 40px; text-align:center; color:#444;">No global posts.</div>`;
                return;
            }
            container.innerHTML = posts.map((p, i) => `
                <div class="post-card" style="transform: translateX(${(i - cur) * 100}%);">
                    <div class="card-body">
                        <div class="user-row">
                            <div class="avatar">${p.username ? p.username[0].toUpperCase() : 'C'}</div>
                            <div style="font-weight:700; font-size:14px;">@${p.username || 'cruiser'}</div>
                        </div>
                        <div class="content-text">${p.content}</div>
                    </div>
                </div>
            `).join('');
        }

        // SWIPE
        let sX = 0;
        document.body.addEventListener('touchstart', e => sX = e.touches[0].clientX);
        document.body.addEventListener('touchend', e => {
            let diff = sX - e.changedTouches[0].clientX;
            if(Math.abs(diff) < 50) return;
            if(diff > 50 && cur < posts.length - 1) cur++;
            if(diff < -50 && cur > 0) cur--;
            render();
            tg.HapticFeedback.impactOccurred('medium');
        });

        async function publish() {
            const txt = document.getElementById('post-input').value;
            if(!txt.trim()) return;
            const { error } = await supabaseClient.from('posts').insert([{ 
                username: tg.initDataUnsafe?.user?.first_name || "Guest", 
                content: txt 
            }]);
            if(!error) {
                document.getElementById('post-input').value = "";
                closeEditor();
                cur = 0;
                fetchPosts();
                tg.showAlert("Global Post Success!");
            }
        }

        function switchTab(tab, btn) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + tab).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function openEditor() { document.getElementById('editor').classList.add('active'); }
        function closeEditor() { document.getElementById('editor').classList.remove('active'); }

        fetchPosts();
    </script>
</body>
    </html>
