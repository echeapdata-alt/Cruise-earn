<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cruise Official</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --primary: #2481cc; --bg: #000; --panel: #0a0a0a; --border: #1a1a1a; --text-dim: #888; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg); color: #fff; 
            font-family: -apple-system, system-ui, sans-serif; 
            overflow: hidden; 
        }

        /* HEADER */
        .navbar { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 20px; height: 65px; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            position: sticky; top: 0; z-index: 1000;
        }
        .nav-logo { letter-spacing: 6px; font-weight: 900; font-size: 16px; color: #fff; }
        .status-pill { 
            display: flex; align-items: center; gap: 6px; 
            font-size: 10px; font-weight: 700; color: var(--text-dim);
            padding: 4px 10px; border-radius: 20px; border: 1px solid var(--border);
        }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: #555; }
        .dot.active { background: #00ff00; box-shadow: 0 0 10px #00ff00; }

        /* FEED ENGINE */
        #post-container { 
            position: relative; width: 100%; height: calc(100vh - 65px); 
            background: radial-gradient(circle at center, #050505 0%, #000 100%);
        }
        .post-card { 
            position: absolute; inset: 0; padding: 30px; 
            display: flex; flex-direction: column; justify-content: center;
            background: transparent;
            transition: transform 0.6s cubic-bezier(0.2, 1, 0.2, 1);
            will-change: transform;
        }

        /* CARD CONTENT */
        .card-inner {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 32px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            max-height: 80%;
            display: flex;
            flex-direction: column;
        }
        .post-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
        .post-pfp { 
            width: 44px; height: 44px; border-radius: 14px; 
            background: linear-gradient(135deg, #1a1a1a, #0a0a0a); 
            display: flex; align-items: center; justify-content: center; 
            border: 1px solid var(--border); color: var(--primary); font-weight: 800;
        }
        .username { font-weight: 700; font-size: 15px; color: #fff; }
        .post-content { 
            font-size: 20px; line-height: 1.6; color: #efefef; 
            overflow-y: auto; padding-right: 5px;
        }

        /* BUTTONS */
        .create-btn { 
            position: fixed; bottom: 35px; right: 25px; 
            width: 64px; height: 64px; background: var(--primary); 
            border-radius: 22px; border: none; color: #fff; font-size: 32px; 
            z-index: 5000; box-shadow: 0 12px 24px rgba(36, 129, 204, 0.4);
            display: flex; align-items: center; justify-content: center;
        }

        /* EDITOR OVERLAY */
        #editor { 
            position: fixed; inset: 0; background: #000; z-index: 10000; 
            transform: translateY(100%); transition: 0.5s cubic-bezier(0.1, 0.9, 0.1, 1); 
            padding: 25px; display: flex; flex-direction: column; 
        }
        #editor.active { transform: translateY(0); }
        .ed-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        #post-text { 
            flex: 1; background: transparent; border: none; color: #fff; 
            font-size: 22px; resize: none; line-height: 1.5;
        }

        /* HINT */
        .swipe-hint {
            position: absolute; bottom: 100px; width: 100%; text-align: center;
            font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 2px;
            opacity: 0.5; animation: breathe 2s infinite;
        }
        @keyframes breathe { 0%, 100% { opacity: 0.2; } 50% { opacity: 0.6; } }
    </style>
</head>
<body>

    <nav class="navbar">
        <div style="width: 24px;"></div>
        <div class="nav-logo">CRUISE</div>
        <div class="status-pill">
            <div id="dot" class="dot"></div>
            <span id="st-text">SYNCING</span>
        </div>
    </nav>

    <div id="post-container">
        <div class="swipe-hint">Swipe to Explore</div>
    </div>
    
    <button class="create-btn" onclick="openEd()">+</button>

    <div id="editor">
        <div class="ed-nav">
            <button onclick="closeEd()" style="background:none; border:none; color:var(--text-dim); font-size:16px;">Close</button>
            <button onclick="publish()" style="background:var(--primary); color:#fff; border:none; padding:10px 25px; border-radius:15px; font-weight:800;">Publish</button>
        </div>
        <textarea id="post-text" placeholder="Share a thought..."></textarea>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        // API CONFIG
        const SB_URL = "https://chsybopznpfdvhmdspox.supabase.co"; 
        const SB_KEY = "sb_publishable_IfqycsZxpWeXgSPA5U7D5w_u-nl_FJf";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        let posts = [];
        let cur = 0;

        async function fetchPosts() {
            const { data, error } = await supabaseClient.from('posts').select('*').order('created_at', { ascending: false });
            if (!error) {
                posts = data;
                document.getElementById('dot').className = "dot active";
                document.getElementById('st-text').innerText = "LIVE";
                render();
            } else {
                document.getElementById('st-text').innerText = "ERROR";
            }
        }

        function render() {
            const container = document.getElementById('post-container');
            if (posts.length === 0) {
                container.innerHTML = `<div style="padding:100px 40px; text-align:center; color:#444;">No posts yet.</div>`;
                return;
            }
            container.innerHTML = posts.map((p, i) => `
                <div class="post-card" style="transform: translateX(${(i - cur) * 100}%);">
                    <div class="card-inner">
                        <div class="post-header">
                            <div class="post-pfp">${p.username ? p.username[0].toUpperCase() : 'C'}</div>
                            <div class="username">@${p.username ? p.username.toLowerCase() : 'cruiser'}</div>
                        </div>
                        <div class="post-content">${p.content}</div>
                    </div>
                </div>
            `).join('') + `<div class="swipe-hint">Swipe to Explore</div>`;
        }

        // SWIPE SYSTEM
        let sX = 0;
        document.body.addEventListener('touchstart', e => sX = e.touches[0].clientX);
        document.body.addEventListener('touchend', e => {
            let diff = sX - e.changedTouches[0].clientX;
            if(Math.abs(diff) < 50) return;
            if(diff > 50 && cur < posts.length - 1) cur++;
            if(diff < -50 && cur > 0) cur--;
            render();
            tg.HapticFeedback.impactOccurred('medium');
        });

        async function publish() {
            const txt = document.getElementById('post-text').value;
            if(!txt.trim()) return;
            
            const { error } = await supabaseClient.from('posts').insert([{ 
                username: tg.initDataUnsafe?.user?.first_name || "Guest", 
                content: txt 
            }]);

            if(!error) {
                document.getElementById('post-text').value = "";
                closeEd();
                cur = 0;
                fetchPosts();
                tg.HapticFeedback.notificationOccurred('success');
            }
        }

        function openEd() { document.getElementById('editor').classList.add('active'); }
        function closeEd() { document.getElementById('editor').classList.remove('active'); }

        fetchPosts();
    </script>
</body>
    </html>
