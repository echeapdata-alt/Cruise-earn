<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cruise Official</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --primary: #2481cc; --bg: #000; --panel: #0a0a0a; --border: #1a1a1a; --text-dim: #888; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg); color: #fff; 
            font-family: -apple-system, system-ui, sans-serif; 
            overflow: hidden; 
        }

        /* TOP NAVBAR */
        .navbar { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 20px; height: 60px; 
            background: #000; border-bottom: 1px solid var(--border);
            position: fixed; top: 0; width: 100%; z-index: 1000;
        }
        .logo-area { display: flex; align-items: center; gap: 10px; }
        .logo-text { letter-spacing: 5px; font-weight: 900; font-size: 18px; color: #fff; margin: 0; }
        .status-pill { font-size: 9px; color: #00ff00; border: 1px solid #00ff0044; padding: 2px 8px; border-radius: 10px; text-transform: uppercase; font-weight: bold; }

        /* MAIN VIEWPORT */
        .main-content { margin-top: 60px; height: calc(100vh - 130px); width: 100%; position: relative; }
        .view { display: none; height: 100%; width: 100%; overflow: hidden; }
        .view.active { display: block; }

        /* FEED DESIGN */
        #post-container { position: relative; height: 100%; width: 100%; }
        .post-card { 
            position: absolute; inset: 0; padding: 20px; 
            display: flex; flex-direction: column; justify-content: center;
            background: #000; transition: transform 0.5s cubic-bezier(0.2, 1, 0.3, 1);
        }
        .card-inner {
            background: var(--panel); border: 1px solid var(--border);
            border-radius: 28px; padding: 25px;
            display: flex; flex-direction: column; gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .u-info { display: flex; align-items: center; gap: 12px; }
        .u-avatar { width: 38px; height: 38px; border-radius: 10px; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 14px; }
        .u-name { font-weight: 700; font-size: 14px; }
        .p-text { font-size: 18px; line-height: 1.5; color: #ddd; overflow-y: auto; max-height: 250px; }

        /* BOTTOM MENU */
        .tab-bar { 
            position: fixed; bottom: 0; width: 100%; height: 70px; 
            background: #050505; border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center; padding-bottom: 10px;
        }
        .tab-btn { background: none; border: none; color: #555; display: flex; flex-direction: column; align-items: center; font-size: 10px; font-weight: 600; gap: 4px; }
        .tab-btn.active { color: var(--primary); }
        .tab-btn i { font-size: 22px; font-style: normal; }

        /* POST MODAL */
        #editor { 
            position: fixed; inset: 0; background: #000; z-index: 2000; 
            transform: translateY(100%); transition: 0.4s cubic-bezier(0.1, 0.8, 0.1, 1); 
            padding: 25px; display: flex; flex-direction: column; 
        }
        #editor.active { transform: translateY(0); }
        .ed-header { display: flex; justify-content: space-between; margin-bottom: 30px; }
        #post-input { flex: 1; background: transparent; border: none; color: #fff; font-size: 20px; resize: none; }
        
        /* UPLOAD AREA */
        .upload-zone { border-top: 1px solid var(--border); padding: 20px 0; }
        .btn-file { background: #111; color: var(--primary); padding: 12px 20px; border-radius: 12px; font-weight: bold; border: 1px solid var(--border); cursor: pointer; display: inline-block; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo-area">
            <h1 class="logo-text">CRUISE</h1>
            <span class="status-pill" id="st-tag">Global</span>
        </div>
        <button onclick="fetchPosts()" style="background:none; border:none; color:#444; font-size:18px;">‚Üª</button>
    </nav>

    <div class="main-content">
        <div id="view-home" class="view active">
            <div id="post-container"></div>
        </div>

        <div id="view-shorts" class="view">
            <div style="height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#444;">
                <span style="font-size:40px;">üé¨</span>
                <p>Shorts Engine Ready</p>
            </div>
        </div>

        <div id="view-profile" class="view">
            <div style="padding:40px; text-align:center;">
                <div id="user-pfp" style="width:100px; height:100px; background:var(--primary); border-radius:30px; margin:0 auto 20px; display:flex; align-items:center; justify-content:center; font-size:40px; font-weight:bold;">?</div>
                <h2 id="user-name">Cruiser</h2>
                <div style="display:flex; justify-content:center; gap:20px; margin-top:20px; color:#888; font-size:12px;">
                    <div><b>0</b><br>POSTS</div>
                    <div><b>0</b><br>FOLLOWERS</div>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="showTab('home', this)"><i>üöÄ</i><span>Feed</span></button>
        <button class="tab-btn" onclick="showTab('shorts', this)"><i>üé¨</i><span>Shorts</span></button>
        <button class="tab-btn" onclick="openEd()" style="transform:translateY(-10px);"><span style="font-size:45px; color:var(--primary);">+</span></button>
        <button class="tab-btn" onclick="showTab('profile', this)"><i>üë§</i><span>Profile</span></button>
    </div>

    <div id="editor">
        <div class="ed-header">
            <button onclick="closeEd()" style="background:none; border:none; color:#666; font-size:16px;">Cancel</button>
            <button onclick="publish()" style="background:var(--primary); color:#fff; border:none; padding:10px 25px; border-radius:15px; font-weight:800;">Publish</button>
        </div>
        <textarea id="post-input" placeholder="What's happening?"></textarea>
        
        <div class="upload-zone">
            <label for="up-file" class="btn-file">üñºÔ∏è From Gallery</label>
            <input type="file" id="up-file" accept="image/*,video/*" style="display:none;" onchange="handleFile(this)">
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // SUPABASE CONNECTION
        const SB_URL = "https://chsybopznpfdvhmdspox.supabase.co"; 
        const SB_KEY = "sb_publishable_IfqycsZxpWeXgSPA5U7D5w_u-nl_FJf";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        let posts = [];
        let cur = 0;

        // USER SETUP
        if(tg.initDataUnsafe?.user) {
            const user = tg.initDataUnsafe.user;
            document.getElementById('user-name').innerText = user.first_name;
            document.getElementById('user-pfp').innerText = user.first_name[0];
        }

        async function fetchPosts() {
            const { data, error } = await supabaseClient.from('posts').select('*').order('created_at', { ascending: false });
            if (!error) {
                posts = data;
                document.getElementById('st-tag').innerText = "Live";
                document.getElementById('st-tag').style.color = "#00ff00";
                render();
            }
        }

        function render() {
            const container = document.getElementById('post-container');
            if (posts.length === 0) {
                container.innerHTML = `<div style="padding:100px 40px; text-align:center; opacity:0.3;">No global posts yet.</div>`;
                return;
            }
            container.innerHTML = posts.map((p, i) => `
                <div class="post-card" style="transform: translateX(${(i - cur) * 100}%);">
                    <div class="card-inner">
                        <div class="u-info">
                            <div class="u-avatar">${p.username ? p.username[0].toUpperCase() : 'C'}</div>
                            <div class="u-name">@${p.username ? p.username.toLowerCase() : 'cruiser'}</div>
                        </div>
                        <div class="p-text">${p.content}</div>
                    </div>
                </div>
            `).join('');
        }

        // SWIPE LOGIC
        let sX = 0;
        document.body.addEventListener('touchstart', e => sX = e.touches[0].clientX);
        document.body.addEventListener('touchend', e => {
            let diff = sX - e.changedTouches[0].clientX;
            if(Math.abs(diff) < 50) return;
            if(diff > 50 && cur < posts.length - 1) cur++;
            if(diff < -50 && cur > 0) cur--;
            render();
            tg.HapticFeedback.impactOccurred('light');
        });

        async function publish() {
            const val = document.getElementById('post-input').value;
            if(!val.trim()) return;
            
            const { error } = await supabaseClient.from('posts').insert([{ 
                username: tg.initDataUnsafe?.user?.first_name || "Guest", 
                content: val 
            }]);

            if(!error) {
                document.getElementById('post-input').value = "";
                closeEd();
                cur = 0;
                fetchPosts();
                tg.showAlert("Cruised to the global feed!");
            }
        }

        function showTab(id, btn) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + id).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function handleFile(input) {
            if(input.files[0]) tg.showAlert("File detected! We need to set up Supabase Storage to save this permanently.");
        }

        function openEd() { document.getElementById('editor').classList.add('active'); }
        function closeEd() { document.getElementById('editor').classList.remove('active'); }

        fetchPosts();
    </script>
</body>
    </html>
